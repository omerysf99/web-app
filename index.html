<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Tron Ads Faucet</title>
    
    <script src="https://telegram.org/js/telegram-web-app.js?56"></script>
    
    <script src="https://adexora.com/cdn/ads.js?id=494"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;600;700;800&display=swap" rel="stylesheet">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" />
    
    <style>
        :root {
            --font-family: 'Nunito', sans-serif;
            --bg-color: #f0f2f5;
            --card-bg: #ffffff;
            --text-color: #1c1c1e;
            --subtle-text: #888;
            --primary-color: #D32F2F;
            --primary-color-hover: #B71C1C;
            --border-color: #e0e0e0;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --radius: 12px;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: var(--font-family);
            background-color: var(--bg-color);
            color: var(--text-color);
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        #app { max-width: 500px; margin: 0 auto; padding-bottom: 80px; }

        .header { padding: 20px; display: flex; align-items: center; justify-content: space-between; background-color: var(--primary-color); color: white; border-radius: 0 0 var(--radius) var(--radius); box-shadow: var(--shadow); }
        .header h1 { font-size: 1.4rem; font-weight: 800; }
        .header-stats { text-align: right; font-size: 0.9rem; }
        .header-stats p strong { display: block; font-size: 1.1rem; }

        main { padding: 15px; }
        /* Tüm .page'ler başlangıçta gizlenir. */
        .page { display: none; }
        .page.active { display: block; animation: fadeIn 0.4s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.6rem; margin-bottom: 20px; color: var(--primary-color); border-left: 4px solid var(--primary-color); padding-left: 10px; }
        
        .card { padding: 20px; border-radius: var(--radius); background-color: var(--card-bg); box-shadow: var(--shadow); margin-bottom: 20px; transition: transform 0.2s; }
        .card:hover { transform: translateY(-2px); }
        
        .action-btn { width: 100%; padding: 15px; font-size: 1.1rem; font-weight: 700; color: #fff; border: none; border-radius: 10px; cursor: pointer; transition: background-color 0.2s, transform 0.1s; display: flex; justify-content: center; align-items: center; background-color: var(--primary-color); }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:hover { background-color: var(--primary-color-hover); }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .action-btn.loading { background-color: #FF5722; cursor: wait; pointer-events: none; }

        .balance-card { text-align: center; border: 2px solid var(--primary-color); background-color: #FFF3F3; }
        .balance-card .usd-value { font-size: 2.5rem; font-weight: 800; color: var(--primary-color); line-height: 1.2; }
        .balance-card .trx-value { font-size: 1.2rem; color: var(--subtle-text); margin-top: 5px; }
        
        .menu-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap: 15px; }
        .menu-tile { padding: 15px; border-radius: var(--radius); text-align: center; background-color: var(--card-bg); box-shadow: var(--shadow); cursor: pointer; transition: background-color 0.2s, transform 0.1s; }
        .menu-tile i { font-size: 2rem; color: var(--primary-color); margin-bottom: 10px; }
        .menu-tile span { font-size: 1rem; font-weight: 600; display: block; }
        .menu-tile:hover { background-color: #FFFAFA; }

        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: 700; font-size: 0.95rem; color: var(--text-color); }
        input[type="text"], input[type="number"] { width: 100%; padding: 12px; border-radius: 8px; font-family: inherit; font-size: 1rem; border: 1px solid var(--border-color); transition: border-color 0.2s; }
        input[type="text"]:focus, input[type="number"]:focus { border-color: var(--primary-color); outline: none; }
        
        .input-group { display: flex; margin-bottom: 15px; }
        .input-group input { flex-grow: 1; padding: 12px; border-radius: 8px 0 0 8px; font-family: inherit; font-size: 1rem; border: 1px solid var(--border-color); border-right: none; background-color: var(--bg-color); }
        .input-group button { padding: 10px 15px; background-color: var(--primary-color); color: white; border: none; border-radius: 0 8px 8px 0; cursor: pointer; transition: background-color 0.2s; }
        .input-group button:hover { background-color: var(--primary-color-hover); }
        /* Arama kutusu için tam yuvarlak kenarlar */
        #user-search-input { border-radius: 8px; border-right: 1px solid var(--border-color); }
        .input-group #user-search-input + button { border-radius: 0 8px 8px 0; }

        .withdraw-note { font-size: 0.9rem; color: var(--subtle-text); margin-top: 10px; }
        
        #admin-panel .stat-display { display: flex; justify-content: space-between; padding: 10px 0; border-bottom: 1px dashed var(--border-color); font-weight: 600; }
        #admin-panel h3 { margin-top: 20px; color: var(--primary-color); }
        #admin-panel ul { list-style: none; padding: 0; }
        #admin-panel li { border: 1px solid var(--primary-color); border-radius: 8px; padding: 15px; margin-bottom: 10px; background-color: #FFEEEE; }
        #admin-panel li strong { color: var(--primary-color); }
        #admin-panel li button { margin-top: 10px; margin-right: 5px; padding: 8px 12px; border-radius: 5px; font-weight: 700; cursor: pointer; }
        #admin-panel .approve-btn { background-color: #4CAF50; color: white; border: none; }
        #admin-panel .reject-btn { background-color: #f44336; color: white; border: none; }
        #admin-panel .orange-btn { background-color: #ff9800; color: white; border: none; }
        /* Admin paneli Bilgiler butonu */
        #admin-panel .info-btn { background-color: #2196F3; color: white; border: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; max-width: 500px; margin: 0 auto; display: flex; justify-content: space-around; padding: 5px 0; background-color: var(--card-bg); border-top: 1px solid var(--border-color); box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05); z-index: 1000; }
        .nav-btn { background: none; border: none; cursor: pointer; display: flex; flex-direction: column; align-items: center; padding: 5px 10px; font-family: var(--font-family); font-size: 0.75rem; transition: color 0.2s; flex-grow: 1; color: var(--subtle-text); }
        .nav-btn i { font-size: 1.6rem; margin-bottom: 3px; }
        .nav-btn.active { font-weight: 700; color: var(--primary-color); }

        .user-stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 10px 0; }
        .stat-item { background: #f5f5f5; padding: 8px; border-radius: 5px; text-align: center; }
        .stat-value { font-weight: 800; color: var(--primary-color); font-size: 1.1rem; }

        /* YENİ CSS: Kaydırılabilir listeler */
        .scrollable-list {
            max-height: 300px; /* Maksimum yüksekliği belirle */
            overflow-y: auto;  /* Dikey kaydırmayı etkinleştir */
            padding-right: 10px; /* Kaydırma çubuğu için boşluk */
        }
        .scrollable-list::-webkit-scrollbar {
            width: 6px;
        }
        .scrollable-list::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }
    </style>
</head>
<body>

    <div id="app">
        <header class="header">
            <div>
                <h1>TRON Ads Faucet</h1>
                <p style="font-size:0.9rem;">The simplest way to earn TRX.</p>
            </div>
            <div class="header-stats">
                <p>Current Price (TRX)</p>
                <p><strong>$<span id="current-trx-price">0.0000</span></strong></p>
                <div id="admin-indicator" style="display:none; font-weight:bold; color:#FFD700; margin-top:5px;">ADMIN MODE</div>
            </div>
        </header>

        <main id="main-content">
            
            <div id="banned-screen" class="page" style="text-align: center; padding: 40px; background-color: #ffebeb; border: 3px solid #D32F2F; margin-top: 20px;">
                <i class="fas fa-exclamation-triangle" style="font-size: 4rem; color: #D32F2F; margin-bottom: 15px;"></i>
                <h2>ACCOUNT SUSPENDED</h2>
                <p style="font-size: 1.1rem; color: #1c1c1e; margin-bottom: 20px;">Your access to the TRON Ads Faucet has been temporarily or permanently suspended.</p>
                
                <div class="card" style="background-color: #fff; border: 1px solid #f0f0f0;">
                    <h3 style="color: #D32F2F; margin-bottom: 10px;">Reason for Suspension:</h3>
                    <p id="ban-reason-display" style="font-weight: 700; font-size: 1rem; color: #333;">Loading reason...</p>
                </div>

                <p style="margin-top: 25px; font-size: 0.9rem; color: #888;">If you believe this is an error, please contact support with your Telegram ID.</p>
            </div>
            
            <div id="admin-panel" class="page">
                <h2><i class="fas fa-user-shield"></i> Admin Panel</h2>
                
                <div class="card">
                    <h3>System Stats (RTDB)</h3>
                    <div class="stat-display"><span>Total Users:</span> <strong id="admin-user-count">0</strong></div>
                    <div class="stat-display"><span>Total User Balance (USD):</span> <strong id="admin-total-balance">$0.00</strong></div>
                    <div class="stat-display"><span>Total Ads Watched (System):</span> <strong id="admin-total-ads">0</strong></div>
                    <div class="stat-display"><span>Total Referrals:</span> <strong id="admin-total-referrals">0</strong></div>
                </div>
                
                <div class="card">
                    <h3>User Management</h3>
                    <div class="input-group" style="margin-bottom: 10px;">
                        <input type="text" id="user-search-input" placeholder="Search by Telegram ID or Username">
                        <button onclick="loadAllUsers(true)" style="border-radius: 8px;"><i class="fas fa-search"></i> Search</button>
                    </div>
                    <div class="input-group">
                        <input type="text" id="user-uid-input" placeholder="User UID to ban (e.g., tg_user_12345)">
                        <button onclick="manualBanUser(document.getElementById('user-uid-input').value.trim())"><i class="fas fa-ban"></i> Ban User</button>
                    </div>
                    <div style="margin-top: 10px;">
                        <button onclick="loadAllUsers()" class="action-btn" style="padding: 10px;">
                            <i class="fas fa-sync-alt"></i> Refresh All Users
                        </button>
                    </div>
                </div>

                <div class="card">
                    <h3>All Users List (Scrollable)</h3>
                    <div id="users-list-scrollable-container" class="scrollable-list">
                        <ul id="users-list">
                            <p style="color:var(--subtle-text);">Click refresh to load users...</p>
                        </ul>
                    </div>
                </div>

                <div class="card">
                    <h3>Banned Users (Scrollable)</h3>
                    <div id="banned-users-list-scrollable-container" class="scrollable-list">
                        <ul id="banned-users-list">
                            <p style="color:var(--subtle-text);">Loading banned users...</p>
                        </ul>
                    </div>
                </div>
                
                <h3 style="margin-top:25px;">Pending Withdrawal Requests (Firestore - Scrollable)</h3>
                <div class="card" style="margin-top: 10px;">
                    <div id="withdrawal-list-scrollable-container" class="scrollable-list">
                        <ul id="withdrawal-list">
                            <p style="color:var(--subtle-text);">Loading requests...</p>
                        </ul>
                    </div>
                </div>
            </div>

            <div id="menu-page" class="page">
                <h2><i class="fas fa-home"></i> Home & Earning</h2>
                <div class="card balance-card">
                    <p style="font-size:1.1rem; color:var(--subtle-text);">Your Current Balance (TRX)</p>
                    <div class="usd-value"><span id="menu-balance-trx">0.0000</span> TRX</div>
                    <div class="trx-value">≈ $<span id="menu-balance-usd">0.00</span></div>
                </div>
                
                <div class="card" style="text-align: center; border-left: 5px solid var(--primary-color);">
                    <i class="fas fa-video" style="font-size:3rem; color: var(--primary-color);"></i>
                    <h3>Watch & Earn</h3>
                    <p style="margin-bottom:15px;">You earn **$0.001** worth of TRX per rewarded ad.</p>
                    <button id="watch-ad-btn" class="action-btn">
                        <i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad
                    </button>
                    <p class="withdraw-note" style="margin-top:10px;">Ads Watched Today: <strong id="daily-ads-watched">0</strong> / 75</p>
                    <div id="cooldown-timer" style="font-weight: 700; color: #ff9800; margin-top: 10px; display:none;">
                        Next 75 ads available in: <span id="timer-display">Loading...</span>
                    </div>
                </div>
                
                <div class="menu-grid" style="margin-top: 15px;">
                    <div onclick="showSection('friends-page')" class="menu-tile">
                        <i class="fas fa-users"></i>
                        <span>Friends & Referrals</span>
                    </div>
                    <div onclick="showSection('withdraw-page')" class="menu-tile">
                        <i class="fas fa-wallet"></i>
                        <span>Withdraw TRX</span>
                    </div>
                </div>
            </div>

            <div id="friends-page" class="page">
                <h2><i class="fas fa-user-friends"></i> Referral System</h2>
                
                <div class="card" style="text-align:center; border: 2px solid #5cb85c; background-color: #e6ffe6;">
                    <p style="font-size:1rem; color:#3c763d;">Total Referred Friends:</p>
                    <div style="font-size:2.5rem; font-weight:800; color:#4CAF50; line-height:1.2;" id="referral-count-display">0</div>
                </div>
                
                <div class="card">
                    <p style="font-weight:700; color:var(--primary-color);">Referral Bonus: Get **$0.005** worth of TRX for every successful friend!</p>
                    
                    <h3 style="font-size:1.2rem; margin-top:15px; margin-bottom:5px;">Your Referral Link (Share this!)</h3>
                    <div class="input-group">
                        <input type="text" id="referral-code-input" value="" placeholder="Loading..." readonly>
                        <button onclick="copyToClipboard('referral-code-input')"><i class="fas fa-copy"></i> Copy Link</button>
                    </div>
                    
                    <button id="share-ref-btn" class="action-btn" style="margin-top:0;"><i class="fas fa-share-alt" style="margin-right:10px;"></i> Share Promotional Text</button>

                    <h3 style="font-size:1.2rem; margin-top:25px; margin-bottom:5px;">Enter Friend's Code</h3>
                    <p class="withdraw-note">You can only use one code once.</p>
                    <div class="input-group">
                        <input type="text" id="enter-referrer-code" placeholder="Enter friend's Telegram ID">
                        <button onclick="applyReferralCode()"><i class="fas fa-arrow-right"></i> Apply</button>
                    </div>
                </div>
                
                </div>
            
            <div id="withdraw-page" class="page">
                <h2><i class="fas fa-money-check-alt"></i> Withdraw TRX</h2>
                <div class="card balance-card" style="margin-bottom: 20px;">
                    <p style="font-size:0.9rem; color:var(--subtle-text);">Available TRX:</p>
                    <div class="usd-value" style="font-size:2rem;"><span id="withdraw-balance-trx">0.0000</span> TRX</div>
                </div>
                
                <p style="font-weight:700;">Minimum withdrawal: **2.50 TRX**.<br>Maximum withdrawal: **10.00 TRX**.</p>
                <form id="withdraw-form" style="margin-top:15px;">
                    <div class="form-group">
                        <label for="tron-address"><i class="fas fa-truck-moving"></i> TRON Wallet Address:</label>
                        <input type="text" id="tron-address" placeholder="Txxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" required>
                    </div>
                    <div class="form-group">
                        <label for="amount-trx"><i class="fas fa-coins"></i> Amount (TRX):</label>
                        <input type="number" id="amount-trx" step="0.001" placeholder="e.g., 2.50" required>
                    </div>
                    <p class="withdraw-note">This equals: <strong id="withdraw-usd-amount">$0.00</strong> USD</p>
                    <button type="submit" id="withdraw-submit-btn" class="action-btn" style="margin-top:15px;">
                        <i class="fas fa-paper-plane" style="margin-right:10px;"></i> Submit Withdrawal Request
                    </button>
                </form>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-btn" data-page="menu-page"><i class="fas fa-home"></i><span>Home</span></button>
            <button class="nav-btn" data-page="friends-page"><i class="fas fa-users"></i><span>Friends</span></button>
            <button class="nav-btn" data-page="withdraw-page"><i class="fas fa-wallet"></i><span>Withdraw</span></button>
        </nav>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
        import { getDatabase, ref as rtdbRef, get as rtdbGet, set as rtdbSet, update as rtdbUpdate, onValue as rtdbOnValue, serverTimestamp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
        import { getFirestore, collection, addDoc, doc, updateDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore.js";

        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAYJqf6Y090mN4fjQAR9m7hNil7hjn0HMg",
            authDomain: "tronadsfaucet-fd451.firebaseapp.com",
            databaseURL: "https://tronadsfaucet-fd451-default-rtdb.firebaseio.com",
            projectId: "tronadsfaucet-fd451",
            storageBucket: "tronadsfaucet-fd451.appspot.com",
            messagingSenderId: "110511122993",
            appId: "1:110511122993:web:99099461844e1fbbe10310",
            measurementId: "G-VZ3Z6SFMXZ"
        };
        const ADMIN_TELEGRAM_IDS = ["7904032877", "8392479231"]; 
        const AD_LIMIT = 75; // Günlük ödüllü reklam limiti
        const EARNINGS_PER_AD_USD = 0.001;
        const REFERRAL_BONUS_USD = 0.005; 
        const MIN_WITHDRAW_TRX = 2.5;
        const MAX_WITHDRAW_TRX = 10.00; 
        const BOT_USERNAME = "TronAdsFaucetBot"; 
        
        const SECURITY_CONFIG = {
            MAX_BALANCE_INCREASE_PER_MINUTE: 0.10,
            MAX_ADS_PER_MINUTE: 5,
            SUSPICIOUS_ACTIVITY_LIMIT: 3,
            CHECK_INTERVAL: 60000
        };

        const RESET_TIME_UTC_HOUR = 0; // Midnight UTC
        const MILLISECONDS_IN_DAY = 24 * 60 * 60 * 1000;

        let currentTronPriceUsd = 0.0; 
        let userUid = null;
        let telegramId = null;

        const app = initializeApp(FIREBASE_CONFIG);
        const rtdb = getDatabase(app);
        const firestore = getFirestore(app);

        const getUidFromTelegramId = (id) => `tg_user_${id}`;
        
        window.showSection = (sectionId) => {
            document.querySelectorAll('.page').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(sectionId).classList.add('active');
            
            document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelector(`.nav-btn[data-page="${sectionId}"]`)?.classList.add('active');

            if (sectionId === 'menu-page') {
                updateAdCooldown(); 
            }

            if (sectionId === 'admin-panel') {
                loadAdminPanel();
                loadBannedUsers(); 
                loadAllUsers(); 
            }
        }

        window.copyToClipboard = (elementId) => {
            const copyText = document.getElementById(elementId);
            const code = copyText.value;
            const fullLink = `https://t.me/${BOT_USERNAME}?start=${code}`;

            navigator.clipboard.writeText(fullLink).then(() => {
                window.Telegram.WebApp.showAlert("Referral Link copied to clipboard!");
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            }).catch(err => {
                 window.Telegram.WebApp.showAlert(`Failed to copy: ${err}`);
            });
        }
        
        async function checkUserBan() {
            if (!userUid) return false;
            
            const bannedUserRef = rtdbRef(rtdb, 'banned_users/' + userUid); 
            
            const snapshot = await rtdbGet(bannedUserRef);
            if (snapshot.exists()) {
                const banData = snapshot.val();
                const banReason = banData.reason || "Multiple security violations detected (Cheat System).";
                
                document.getElementById('ban-reason-display').textContent = banReason;
                
                const bottomNav = document.querySelector('.bottom-nav');
                if (bottomNav) {
                    bottomNav.style.display = 'none';
                }
                
                document.querySelectorAll('.page').forEach(section => {
                    section.classList.remove('active');
                });
                document.getElementById('banned-screen').classList.add('active');

                window.Telegram.WebApp.showAlert(`Account suspended. Reason: ${banReason}`);
                
                return true;
            }
            return false;
        }

        async function autoBanUser(reason, userUid, telegramId) {
            const banRef = rtdbRef(rtdb, 'banned_users/' + userUid);
            const activityRef = rtdbRef(rtdb, 'suspicious_activity/' + userUid + '/' + Date.now());
            
            const banData = {
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                banned_at: serverTimestamp(),
                banned_by: 'AUTO_SYSTEM'
            };
            
            const activityData = {
                user_id: userUid,
                telegram_id: telegramId,
                reason: reason,
                detected_at: serverTimestamp(),
                action_taken: 'AUTO_BANNED'
            };
            
            await Promise.all([
                rtdbSet(banRef, banData),
                rtdbSet(activityRef, activityData)
            ]);
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            await rtdbUpdate(userRef, {
                balance_usd: 0,
                daily_ads_watched: 0,
                total_ads_watched: 0,
                is_banned: true,
                ban_reason: reason
            });
        }

        function detectSuspiciousActivity(userData, previousData) {
            const suspiciousFlags = [];
            
            if (!previousData) return suspiciousFlags;
            
            const balanceIncrease = userData.balance_usd - (previousData.balance_usd || 0);
            if (balanceIncrease > SECURITY_CONFIG.MAX_BALANCE_INCREASE_PER_MINUTE) {
                suspiciousFlags.push(`Abnormal balance increase: $${balanceIncrease}`);
            }
            
            const adsIncrease = userData.daily_ads_watched - (previousData.daily_ads_watched || 0);
            if (adsIncrease > SECURITY_CONFIG.MAX_ADS_PER_MINUTE) {
                suspiciousFlags.push(`Abnormal ad speed: ${adsIncrease} ads/minute`);
            }
            
            if (userData.balance_usd < 0) {
                suspiciousFlags.push(`Negative balance: $${userData.balance_usd}`);
            }
            
            return suspiciousFlags;
        }

        function setupSecurityMonitor() {
            if (!userUid) return;
            
            let previousUserData = null;
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            rtdbOnValue(userRef, async (snapshot) => {
                const currentData = snapshot.val();
                if (!currentData || !previousUserData) {
                    previousUserData = currentData;
                    return;
                }
                
                const suspiciousActivities = detectSuspiciousActivity(currentData, previousUserData);
                
                if (suspiciousActivities.length > 0) {
                    const reason = suspiciousActivities.join(' | ');
                    
                    const suspicionCount = (currentData.suspicion_count || 0) + 1;
                    await rtdbUpdate(userRef, { suspicion_count: suspicionCount });
                    
                    if (suspicionCount >= SECURITY_CONFIG.SUSPICIOUS_ACTIVITY_LIMIT) {
                        await autoBanUser(`Multiple cheat detection: ${reason}`, userUid, telegramId); 
                        window.Telegram.WebApp.showAlert("Security violation detected. Your account has been suspended.");
                        window.Telegram.WebApp.close();
                    }
                }
                
                previousUserData = currentData;
            });
        }

        // GÜNCELLENMİŞ loadAllUsers fonksiyonu (Arama/Filtreleme eklendi)
        function loadAllUsers() {
            const usersRef = rtdbRef(rtdb, 'users');
            const ul = document.getElementById('users-list');
            const searchTerm = document.getElementById('user-search-input').value.trim().toLowerCase(); 

            ul.innerHTML = '<p style="color:var(--subtle-text);">Loading users...</p>';
            
            rtdbOnValue(usersRef, (snapshot) => {
                ul.innerHTML = '';
                
                if (!snapshot.exists()) {
                    ul.innerHTML = '<p style="color:green;">No users found.</p>';
                    return;
                }
                
                const users = [];
                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    users.push({
                        uid: userSnapshot.key,
                        telegram_id: userData.telegram_id,
                        username: userData.username || 'N/A',
                        balance_usd: userData.balance_usd || 0,
                        daily_ads_watched: userData.daily_ads_watched || 0, // Günlük reklam izleme bilgisini çek
                        total_ads_watched: userData.total_ads_watched || 0,
                        referral_count: userData.referral_count || 0,
                        created_at: userData.created_at
                    });
                });
                
                // Bakiyeye göre sırala (yüksek bakiye üstte)
                users.sort((a, b) => b.balance_usd - a.balance_usd);
                
                let filteredCount = 0;

                users.forEach(user => {
                    // FİLTRELEME MANTIĞI
                    const matchesSearch = searchTerm === '' || 
                                          user.telegram_id.includes(searchTerm) || 
                                          user.username.toLowerCase().includes(searchTerm) ||
                                          user.uid.toLowerCase().includes(searchTerm);
                    
                    if (matchesSearch) {
                        const li = document.createElement('li');
                        li.style.padding = '10px';
                        li.style.marginBottom = '8px';
                        li.style.border = '1px solid #ddd';
                        li.style.borderRadius = '5px';
                        li.style.backgroundColor = '#f9f9f9';
                        
                        li.innerHTML = `
                            <p><strong>User:</strong> ${user.username} (ID: ${user.telegram_id})</p>
                            <p><strong>UID:</strong> <code>${user.uid}</code></p>
                            <div class="user-stats-grid">
                                <div class="stat-item">
                                    <div>Balance</div>
                                    <div class="stat-value">$${user.balance_usd.toFixed(4)}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Referrals</div>
                                    <div class="stat-value">${user.referral_count}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Total Ads</div>
                                    <div class="stat-value">${user.total_ads_watched}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Daily Ads</div>
                                    <div class="stat-value">${user.daily_ads_watched}</div>
                                </div>
                            </div>
                            <div style="margin-top: 8px;">
                                <button onclick="manualBanUser('${user.uid}', '${user.telegram_id}')" class="reject-btn" style="padding: 5px 8px; font-size: 0.8rem;">
                                    <i class="fas fa-ban"></i> Ban User
                                </button>
                                <button onclick="viewUserDetails('${user.uid}')" class="approve-btn" style="padding: 5px 8px; font-size: 0.8rem; margin-left: 5px;">
                                    <i class="fas fa-info"></i> Details
                                </button>
                            </div>
                        `;
                        ul.appendChild(li);
                        filteredCount++;
                    }
                });

                if (filteredCount === 0) {
                    ul.innerHTML = '<p style="color:var(--primary-color);">No users found matching the criteria.</p>';
                }
            });
        }

        window.manualBanUser = (uid, telegramId = 'Unknown') => {
            if (!uid || !uid.startsWith('tg_user_')) {
                return window.Telegram.WebApp.showAlert("Invalid User UID format. Example: tg_user_12345");
            }
            
            const banRef = rtdbRef(rtdb, 'banned_users/' + uid);
            rtdbSet(banRef, {
                user_id: uid,
                telegram_id: telegramId,
                banned_at: serverTimestamp(),
                banned_by: 'Admin Manual Ban',
                reason: "Manual ban by admin"
            }).then(() => {
                window.Telegram.WebApp.showAlert(`User ${telegramId} (UID: ${uid}) banned successfully.`);
                loadBannedUsers();
            });
        };

        window.banUserByInput = () => {
            const uid = document.getElementById('user-uid-input').value.trim();
            if (!uid) return window.Telegram.WebApp.showAlert("Please enter a User UID.");
            
            manualBanUser(uid, 'Manual Input');
            document.getElementById('user-uid-input').value = '';
        };

        window.viewUserDetails = (userId) => {
            const userRef = rtdbRef(rtdb, 'users/' + userId);
            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val();
                if (userData) {
                    let details = `📊 User Details:\n\n`;
                    details += `👤 Username: ${userData.username}\n`;
                    details += `🆔 Telegram ID: ${userData.telegram_id}\n`;
                    details += `💰 Balance: $${userData.balance_usd?.toFixed(4) || '0'}\n`;
                    details += `📈 Total Ads: ${userData.total_ads_watched || '0'}\n`;
                    details += `📅 Daily Ads: ${userData.daily_ads_watched || '0'}\n`;
                    details += `👥 Referrals: ${userData.referral_count || '0'}\n`;
                    details += `🤝 Referred by: ${userData.referred_by || 'None'}\n`;
                    details += `🕒 Created: ${userData.created_at ? new Date(userData.created_at).toLocaleString() : 'Unknown'}`;
                    
                    window.Telegram.WebApp.showAlert(details);
                }
            });
        };

        function loadBannedUsers() {
            const bannedRef = rtdbRef(rtdb, 'banned_users');
            const ul = document.getElementById('banned-users-list');
            ul.innerHTML = '';
            
            rtdbOnValue(bannedRef, (snapshot) => {
                ul.innerHTML = '';

                if (!snapshot.exists()) {
                    ul.innerHTML = '<p style="color:green;">No banned users.</p>';
                    return;
                }
                
                snapshot.forEach(userSnapshot => {
                    const banData = userSnapshot.val();
                    const li = document.createElement('li');
                    li.style.backgroundColor = '#f9e8e8'; 
                    li.style.border = '1px solid #ffaaaa';

                    li.innerHTML = `
                        <p><strong>Telegram ID:</strong> ${banData.telegram_id || 'Unknown'}</p>
                        <p><strong>UID:</strong> ${banData.user_id}</p>
                        <p><strong>Reason:</strong> ${banData.reason}</p>
                        <p><strong>Banned by:</strong> ${banData.banned_by}</p>
                        <p><strong>Date:</strong> ${new Date(banData.banned_at).toLocaleString()}</p>
                        <button onclick="manualUnbanUserByKey('${userSnapshot.key}')" class="approve-btn" style="background-color:#5cb85c;">Unban</button>
                    `;
                    ul.appendChild(li);
                });
            });
        }

        window.manualUnbanUserByKey = async (userKey) => {
            const banRef = rtdbRef(rtdb, 'banned_users/' + userKey);
            await rtdbSet(banRef, null);
            window.Telegram.WebApp.showAlert("User unbanned successfully.");
            loadBannedUsers();
        };
        
        async function fetchTronPrice() {
            try {
                const response = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=tron&vs_currencies=usd');
                const data = await response.json();
                currentTronPriceUsd = data.tron.usd;
                document.getElementById('current-trx-price').textContent = currentTronPriceUsd.toFixed(4);
            } catch (error) {
                currentTronPriceUsd = 0.03389;
                document.getElementById('current-trx-price').textContent = `F: ${currentTronPriceUsd.toFixed(4)}`;
            }
        }

        let adCooldownInterval = null;
        
        function getNextResetTime() {
            const now = new Date();
            const todayReset = new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), now.getUTCDate(), RESET_TIME_UTC_HOUR, 0, 0, 0));
            
            // If the reset time has already passed today (UTC), set it for tomorrow
            if (now.getTime() >= todayReset.getTime()) {
                const tomorrowReset = new Date(todayReset.getTime() + MILLISECONDS_IN_DAY);
                return tomorrowReset;
            }
            return todayReset;
        }

        // DÜZELTME 1: Limit dolduğunda butonu tamamen devre dışı bırak ve doğru metni göster.
        function updateAdCooldown() {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const timerDisplay = document.getElementById('timer-display');
            const cooldownDiv = document.getElementById('cooldown-timer');
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val();
                let adsWatched = userData?.daily_ads_watched || 0; // Null check eklendi
                
                if (adsWatched < AD_LIMIT) {
                    cooldownDiv.style.display = 'none';
                    watchAdBtn.disabled = false;
                    watchAdBtn.innerHTML = '<i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad';
                    clearInterval(adCooldownInterval);
                    return;
                }
                
                // Limit aşıldı - Butonu devre dışı bırak ve limit metnini göster
                const nextReset = getNextResetTime();
                
                cooldownDiv.style.display = 'block';
                
                // *** DÜZELTME BURADA ***
                watchAdBtn.disabled = true; 
                watchAdBtn.classList.remove('loading');
                watchAdBtn.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right:10px;"></i> Daily Limit Reached'; 
                // *** DÜZELTME SONU ***

                if (adCooldownInterval) {
                    clearInterval(adCooldownInterval);
                }
                
                adCooldownInterval = setInterval(() => {
                    const now = new Date().getTime();
                    const distance = nextReset.getTime() - now;
                    
                    if (distance < 0) {
                        clearInterval(adCooldownInterval);
                        timerDisplay.textContent = "Resetting now...";
                        // Trigger a soft reset check for the user in RTDB to reset daily_ads_watched
                        rtdbUpdate(userRef, { last_reset_check: serverTimestamp() });
                        updateAdCooldown(); // Re-check user data after potential reset
                        return;
                    }
                    
                    const hours = Math.floor((distance % MILLISECONDS_IN_DAY) / (1000 * 60 * 60));
                    const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
                    const seconds = Math.floor((distance % (1000 * 60)) / 1000);
                    
                    timerDisplay.textContent = `${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
                }, 1000);

            });
        }
        
        function setupUserListener() {
            if (!userUid) return;
            
            const userRef = rtdbRef(rtdb, 'users/' + userUid); 
            
            rtdbOnValue(userRef, (snapshot) => {
                let userData = snapshot.val();
                
                if (!snapshot.exists()) {
                    // *** DÜZELTME 3: KULLANICI KAYDI BURADAN KALDIRILDI ***
                    // Kullanıcı kaydı artık BOT'un /start komutunda yapılmalıdır.
                    // Eğer kullanıcı /start yapmadan mini uygulamayı açarsa, burada bir uyarı gösterilebilir.
                    window.Telegram.WebApp.showAlert("User record not found. Please start the bot first ( /start ).");
                    return;
                }

                // Daily Ads Reset Logic (Client-side approximation, Firebase Rules or a Cloud Function is better for production)
                const now = new Date().getTime();
                const nextResetTime = getNextResetTime().getTime();

                if (now > nextResetTime && (userData.daily_ads_watched || 0) > 0) {
                     // Check if reset has occurred since the reset time
                     const lastResetCheckTime = new Date(userData.last_reset_check || 0).getTime();
                     if (lastResetCheckTime < nextResetTime) {
                         rtdbUpdate(userRef, {
                            daily_ads_watched: 0,
                            last_reset_check: serverTimestamp() 
                         });
                         userData.daily_ads_watched = 0; // Update local data for display immediately
                     }
                }

                const balanceUsd = userData.balance_usd || 0.0;
                const balanceTrx = currentTronPriceUsd > 0 ? (balanceUsd / currentTronPriceUsd) : 0; 
                const dailyWatched = userData.daily_ads_watched || 0;
                const referralCount = userData.referral_count || 0;

                document.getElementById('menu-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('menu-balance-usd').textContent = balanceUsd.toFixed(2);
                document.getElementById('withdraw-balance-trx').textContent = balanceTrx.toFixed(4);
                document.getElementById('daily-ads-watched').textContent = dailyWatched;
                
                document.getElementById('referral-count-display').textContent = referralCount;

                document.getElementById('referral-code-input').value = userData.referral_code;

                if (userData.referred_by) {
                    document.getElementById('enter-referrer-code').disabled = true;
                    document.getElementById('enter-referrer-code').placeholder = `Already referred by: ${userData.referred_by}`;
                    document.querySelector('#friends-page .input-group button').disabled = true;
                }

                updateAdCooldown();
            });
        }
        
        // Ödül verme ve sayaçları artırma mantığı
        const handleRewardAndIncrement = async (userRef) => {
            const snapshotAfterAd = await rtdbGet(userRef);
            const currentData = snapshotAfterAd.val();
            let newAdsWatched = (currentData.daily_ads_watched || 0) + 1;
            let newTotalAdsWatched = (currentData.total_ads_watched || 0) + 1;
            const newBalance = (currentData.balance_usd || 0.0) + EARNINGS_PER_AD_USD;

            await rtdbUpdate(userRef, {
                balance_usd: newBalance,
                daily_ads_watched: newAdsWatched,
                total_ads_watched: newTotalAdsWatched,
                last_ad_viewed: serverTimestamp()
            });
            
            window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
            window.Telegram.WebApp.showAlert(`Success! You earned $${EARNINGS_PER_AD_USD.toFixed(3)} worth of TRX.`);
        }
        
        // Sadece sayaçları artırma mantığı (Ödülsüz reklamlar için)
        // Bu fonksiyon, Düzeltme 2 ile birlikte artık KULLANILMIYOR
        const handleIncrementOnly = async (userRef, adType) => {
             // DÜZELTME: Limit dolduğunda izlenmeye izin verilmediği için bu fonksiyon artık kullanılmayacak.
        }


        // DÜZELTME 2: handleWatchAd fonksiyonu - Limit dolunca reklam izlemeyi tamamen engelleme
        const handleWatchAd = () => {
            const watchAdBtn = document.getElementById('watch-ad-btn');
            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            
            if (typeof window.showAdexora !== 'function') {
                return window.Telegram.WebApp.showAlert("Adexora ad engine is not initialized. Please check the script or refresh the app.");
            }

            rtdbGet(userRef).then((snapshot) => {
                const userData = snapshot.val();
                let adsWatched = userData?.daily_ads_watched || 0; // Null check eklendi

                const isRewardedAdClick = adsWatched < AD_LIMIT;

                if (!isRewardedAdClick) {
                     // LİMİT AŞILDI: Tamamen engelle ve butonu devre dışı bırak
                     watchAdBtn.disabled = true; 
                     watchAdBtn.classList.remove('loading');
                     watchAdBtn.innerHTML = '<i class="fas fa-exclamation-triangle" style="margin-right:10px;"></i> Daily Limit Reached';
                     window.Telegram.WebApp.showAlert(`Daily ad limit (${AD_LIMIT}) has been reached. Please wait for the next reset time.`);
                     updateAdCooldown();
                     return; 
                }
                
                // --- ÖDÜLLÜ REKLAM MANTIĞI BAŞLANGICI ---
                
                watchAdBtn.disabled = true;
                watchAdBtn.classList.add('loading');
                watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:10px;"></i> Loading Rewarded Ad (1/2)...';

                // 1. Ödüllü Reklamı Göster ve Ödül Ver
                window.showAdexora()
                    .then(() => {
                        // Ödül ve sayaç artışı (daily_ads_watched +1, balance +$0.001)
                        return handleRewardAndIncrement(userRef);
                    })
                    .then(() => {
                        // UI'ı İkinci Reklam (Ödülsüz) için güncelle
                        watchAdBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right:10px;"></i> Loading Non-Rewarded Ad (2/2)...';
                        
                        // 2. Ödülsüz Reklamı Göster
                        return window.showAdexora();
                    })
                    .then(() => {
                        // İkinci reklam başarılı. Sadece uyarı veriyoruz ve total_ads_watched'ı 1 artırıyoruz.
                        rtdbGet(userRef).then((s) => {
                             const cData = s.val();
                             rtdbUpdate(userRef, {
                                 // Birinci reklamda zaten 1 artırıldı, burası ikinci artış.
                                 total_ads_watched: (cData.total_ads_watched || 0) + 1, 
                             });
                        });
                        
                        window.Telegram.WebApp.showAlert("Both ads viewed successfully! Your reward has been credited.");
                        
                    })
                    .catch(e => {
                        // Hata yönetimi 
                        const errorMessage = `Ad Error: One of the ads failed to load/show. (${e.message || 'Unknown Error'})`;
                        window.Telegram.WebApp.showAlert(errorMessage);
                        
                    })
                    .finally(() => {
                        // Hata olsa da olmasa da UI temizliği
                        // Limit kontrolü updateAdCooldown içinde yapılacağı için butonu tekrar aktif edebiliriz.
                        watchAdBtn.disabled = false;
                        watchAdBtn.classList.remove('loading');
                        watchAdBtn.innerHTML = '<i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad';
                        updateAdCooldown(); // Buton durumunu yeni sayaca göre ayarla
                    });

            }).catch(e => {
                // Firebase okuma hatası
                window.Telegram.WebApp.showAlert(`Error fetching user data: ${e.message}`);
                watchAdBtn.disabled = false;
                watchAdBtn.classList.remove('loading');
                watchAdBtn.innerHTML = '<i class="fas fa-play-circle" style="margin-right:10px;"></i> Watch Ad';
            });
        }


        const handleShareReferral = () => {
            const userCode = document.getElementById('referral-code-input').value;
            const telegramLink = `https://t.me/${BOT_USERNAME}?start=${userCode}`;
            // REFERRAL BONUS GÜNCELLENDİ
            const shareText = 
`💰 TRON ADS FAUCET - FREE TRX! 🚀

I'm earning free TRX every day just by watching short ads! You can earn up to $0.30 - $3.00 USD daily with minimal effort.

🔥 **REFERRAL BONUS:** Join using my link and start earning. When you invite friends, you get a bonus $${REFERRAL_BONUS_USD.toFixed(3)} worth of TRX for each successful referral!

✅ **MINIMUM WITHDRAWAL:** Only ${MIN_WITHDRAW_TRX.toFixed(2)} TRX. Fast & Easy!

Join now and grab your free crypto reward:
🔗 ${telegramLink}

See you inside! #Tron #TRX #Crypto #FreeMoney`;
            
            if (navigator.share) {
                navigator.share({ 
                    title: 'Tron Ads Faucet - Free TRX!', 
                    text: shareText 
                });
            } else {
                navigator.clipboard.writeText(shareText).then(() => {
                    window.Telegram.WebApp.showAlert("Promotional text copied to clipboard! Share it with your friends!");
                    window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                });
            }
        }

        window.applyReferralCode = () => {
            const referrerCode = document.getElementById('enter-referrer-code').value.trim();
            const userRef = rtdbRef(rtdb, 'users/' + userUid);

            if (!referrerCode) return window.Telegram.WebApp.showAlert("Please enter a referral code.");
            if (referrerCode === telegramId) return window.Telegram.WebApp.showAlert("You cannot refer yourself.");

            rtdbGet(userRef).then((snapshot) => {
                if (snapshot.val()?.referred_by) {
                    return window.Telegram.WebApp.showAlert("You have already used a referral code.");
                }
                
                const referrerUid = getUidFromTelegramId(referrerCode); 
                const referrerRef = rtdbRef(rtdb, 'users/' + referrerUid);

                rtdbGet(referrerRef).then(rSnapshot => {
                    if (!rSnapshot.exists()) return window.Telegram.WebApp.showAlert("Invalid referral code. User not found.");
                    
                    const rData = rSnapshot.val();
                    const newReferrerBalance = (rData.balance_usd || 0.0) + REFERRAL_BONUS_USD;
                    const newReferralCount = (rData.referral_count || 0) + 1;
                    
                    rtdbUpdate(referrerRef, {
                        balance_usd: newReferrerBalance,
                        referral_count: newReferralCount
                    });

                    rtdbUpdate(userRef, {
                        referred_by: referrerCode,
                        referral_applied_at: serverTimestamp() 
                    }).then(() => {
                        window.Telegram.WebApp.showAlert(`Referral code applied successfully! Your referrer received $${REFERRAL_BONUS_USD.toFixed(3)} in TRX.`);
                        document.getElementById('enter-referrer-code').value = '';
                    });
                });
            });
        }

        const handleWithdrawSubmit = (e) => {
            e.preventDefault();
            const withdrawSubmitBtn = document.getElementById('withdraw-submit-btn');
            
            if (!userUid || !telegramId) {
                return window.Telegram.WebApp.showAlert("Withdrawal failed: User session not loaded. Please restart the bot.");
            }

            const userRef = rtdbRef(rtdb, 'users/' + userUid);
            const tronAddress = document.getElementById('tron-address').value.trim();
            const amountInTrx = parseFloat(document.getElementById('amount-trx').value);
            
            if (!tronAddress || !tronAddress.startsWith('T') || tronAddress.length < 34) {
                return window.Telegram.WebApp.showAlert("Please enter a valid TRON address (starts with 'T').");
            }
            if (isNaN(amountInTrx) || amountInTrx <= 0) {
                return window.Telegram.WebApp.showAlert("Please enter a valid amount in TRX.");
            }
            
            if (amountInTrx < MIN_WITHDRAW_TRX) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Minimum withdrawal is ${MIN_WITHDRAW_TRX.toFixed(2)} TRX.`);
            }

            if (amountInTrx > MAX_WITHDRAW_TRX) {
                return window.Telegram.WebApp.showAlert(`Withdrawal failed: Maximum withdrawal is ${MAX_WITHDRAW_TRX.toFixed(2)} TRX.`);
            }
            
            const withdrawUsdAmount = amountInTrx * currentTronPriceUsd;

            withdrawSubmitBtn.disabled = true;

            rtdbGet(userRef).then(snapshot => {
                const userData = snapshot.val();
                
                if (!userData) {
                    throw new Error("User data is missing on Firebase.");
                }
                
                const usdBalance = userData.balance_usd || 0.0;
                
                if (withdrawUsdAmount > usdBalance) {
                    const trxBalance = currentTronPriceUsd > 0 ? (usdBalance / currentTronPriceUsd) : 0; 
                    withdrawSubmitBtn.disabled = false;
                    return window.Telegram.WebApp.showAlert(`Withdrawal failed: Insufficient balance. Available TRX: ${trxBalance.toFixed(4)}`);
                }

                const newUsdBalance = usdBalance - withdrawUsdAmount;

                const requestsCollection = collection(firestore, "withdrawal_requests");
                
                return addDoc(requestsCollection, {
                    user_id: userUid,
                    telegram_id: telegramId,
                    username: userData.username,
                    tron_address: tronAddress,
                    amount_usd: withdrawUsdAmount.toFixed(4),
                    amount_trx: amountInTrx.toFixed(4),
                    status: "Pending", 
                    timestamp: serverTimestamp()
                }).then(() => {
                    return rtdbUpdate(userRef, { balance_usd: newUsdBalance });
                });
                
            }).then(() => {
                window.Telegram.WebApp.showAlert(`Withdrawal request for ${amountInTrx.toFixed(4)} TRX submitted successfully. Your request is now pending admin approval.`);
                document.getElementById('amount-trx').value = '';
                document.getElementById('withdraw-usd-amount').textContent = '$0.00';
            }).catch(e => {
                let errorMessage = "An error occurred during withdrawal. Please try again later.";
                
                if (e.message && e.message.includes("User data is missing")) {
                    errorMessage = "User data could not be initialized. Please restart the bot and try again.";
                } else if (e.code && e.code.includes("permission-denied")) {
                    errorMessage = "Withdrawal failed: Database permission denied. Please check your Firebase Rules.";
                } else if (e.message && e.message.includes("Failed to fetch")) {
                    errorMessage = "Network error: Failed to connect to Firebase. Check your internet.";
                }
                
                window.Telegram.WebApp.showAlert(`Withdrawal failed: ${errorMessage}`);
            }).finally(() => {
                withdrawSubmitBtn.disabled = false;
            });
        }

        function loadAdminPanel() {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                return;
            }
            
            // 1. Load System Stats (RTDB)
            const usersRef = rtdbRef(rtdb, 'users');
            rtdbOnValue(usersRef, (snapshot) => {
                let totalBalance = 0.0;
                let userCount = 0;
                let totalAds = 0;
                let totalReferrals = 0; 

                snapshot.forEach(userSnapshot => {
                    const userData = userSnapshot.val();
                    totalBalance += userData.balance_usd || 0.0;
                    userCount++;
                    totalAds += userData.total_ads_watched || 0;
                    totalReferrals += userData.referral_count || 0; 
                });
                
                document.getElementById('admin-user-count').textContent = userCount;
                document.getElementById('admin-total-balance').textContent = `$${totalBalance.toFixed(2)}`;
                document.getElementById('admin-total-ads').textContent = totalAds.toLocaleString();
                document.getElementById('admin-total-referrals').textContent = totalReferrals.toLocaleString(); 
            });

            // 2. Load Pending Withdrawal Requests (FIRESTORE)
            const requestsColRef = collection(firestore, 'withdrawal_requests');
            const q = query(requestsColRef, where("status", "==", "Pending"));
            
            onSnapshot(q, async (querySnapshot) => {
                const ul = document.getElementById('withdrawal-list');
                ul.innerHTML = '<p style="color:var(--subtle-text);">Loading requests...</p>'; 
                
                const pendingRequests = [];

                querySnapshot.forEach(docSnapshot => {
                    const request = docSnapshot.data();
                    const requestId = docSnapshot.id;
                    const timestamp = request.timestamp?.seconds * 1000 || 0; 
                    pendingRequests.push({ ...request, requestId, timestamp });
                });

                pendingRequests.sort((a, b) => a.timestamp - b.timestamp);

                const requestsWithUserDataPromises = pendingRequests.map(async (request) => {
                    const userRef = rtdbRef(rtdb, 'users/' + request.user_id);
                    const userSnapshot = await rtdbGet(userRef);
                    const userData = userSnapshot.val() || { 
                        balance_usd: 0.0, 
                        daily_ads_watched: 0,
                        total_ads_watched: 0,
                        referral_count: 0
                    };
                    return {
                        ...request,
                        current_balance_usd: userData.balance_usd || 0.0,
                        user_daily_ads: userData.daily_ads_watched || 0, // Günlük reklam bilgisi
                        user_total_ads: userData.total_ads_watched || 0,
                        user_referral_count: userData.referral_count || 0,
                    };
                });
                
                const requestsWithUserData = await Promise.all(requestsWithUserDataPromises);
                
                ul.innerHTML = '';

                if (requestsWithUserData.length === 0) {
                    ul.innerHTML = '<p style="color:green; font-weight:700;">No pending withdrawal requests.</p>';
                } else {
                    requestsWithUserData.forEach(request => {
                        const li = document.createElement('li');
                        
                        li.innerHTML = `
                            <p><strong>User:</strong> ${request.username} (TG ID: ${request.telegram_id})</p>
                            <p><strong>UID:</strong> <code>${request.user_id}</code></p>
                            <div class="user-stats-grid">
                                <div class="stat-item">
                                    <div>Total Ads</div>
                                    <div class="stat-value">${request.user_total_ads}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Referrals</div>
                                    <div class="stat-value">${request.user_referral_count}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Balance</div>
                                    <div class="stat-value">$${request.current_balance_usd.toFixed(4)}</div>
                                </div>
                                <div class="stat-item">
                                    <div>Request</div>
                                    <div class="stat-value">${request.amount_trx} TRX</div>
                                </div>
                            </div>
                            <p><strong>TRON Address:</strong> <code>${request.tron_address}</code></p>
                            <div style="margin-top: 10px;">
                                <button onclick="processWithdrawal('${request.requestId}', 'Completed')" class="approve-btn">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button onclick="processWithdrawal('${request.requestId}', 'Rejected', '${request.user_id}', '${request.amount_usd}')" class="reject-btn">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                                <button onclick="viewWithdrawalDetails('${request.user_id}', ${request.user_total_ads}, ${request.user_referral_count}, ${request.user_daily_ads}, '${request.current_balance_usd.toFixed(4)}', '${request.amount_trx}')" class="info-btn">
                                    <i class="fas fa-info-circle"></i> Details
                                </button>
                                <button onclick="manualBanUser('${request.user_id}', '${request.telegram_id}')" class="orange-btn" style="margin-top: 5px;">
                                    <i class="fas fa-ban"></i> Ban User
                                </button>
                            </div>
                        `;
                        ul.appendChild(li);
                    });
                }
            });
        }
        
        // YENİ FONKSİYON: Çekim Talebi Kullanıcı Detaylarını Göster
        window.viewWithdrawalDetails = (userId, totalAds, referrals, dailyAds, currentBalance, requestedTrx) => {
            let details = `📝 Withdrawal Request Details:\n\n`;
            details += `👤 User UID: ${userId}\n`;
            details += `💰 Current Balance: $${currentBalance} USD\n`;
            details += `💸 Requested: ${requestedTrx} TRX\n`;
            details += `\n--- Usage Stats ---\n`;
            details += `📈 Total Ads Watched: ${totalAds}\n`;
            details += `📅 Daily Ads Watched: ${dailyAds} / ${AD_LIMIT}\n`;
            details += `👥 Total Referrals: ${referrals}\n`;
            
            window.Telegram.WebApp.showAlert(details);
        };


        window.processWithdrawal = (requestId, status, userIdToRefund, amountUsdToRefund) => {
            if (!ADMIN_TELEGRAM_IDS.includes(telegramId)) return;
            
            const requestDocRef = doc(firestore, 'withdrawal_requests', requestId);
            
            updateDoc(requestDocRef, {
                status: status,
                processed_by_admin: telegramId,
                processed_at: serverTimestamp()
            }).then(() => {
                window.Telegram.WebApp.showAlert(`Request ${requestId} set to ${status}.`);
                window.Telegram.WebApp.HapticFeedback.notificationOccurred('success');
                
                if (status === 'Rejected' && userIdToRefund && amountUsdToRefund) {
                    const refundAmount = parseFloat(amountUsdToRefund);
                    if (isNaN(refundAmount) || refundAmount <= 0) {
                        return window.Telegram.WebApp.showAlert("Rejection successful, but refund amount is invalid.");
                    }
                    
                    const userRef = rtdbRef(rtdb, 'users/' + userIdToRefund);
                    rtdbGet(userRef).then(snapshot => {
                        const userData = snapshot.val();
                        if (userData) {
                            const newBalance = (userData.balance_usd || 0.0) + refundAmount;
                            return rtdbUpdate(userRef, { balance_usd: newBalance });
                        }
                    }).then(() => {
                        window.Telegram.WebApp.showAlert(`Request rejected and $${refundAmount.toFixed(4)} refunded to user.`);
                    });
                }
                
            }).catch(e => {
                window.Telegram.WebApp.showAlert(`Admin action failed: ${e.message}`);
            });
        }
        
        function setupEventListeners() {
            document.getElementById('watch-ad-btn').addEventListener('click', handleWatchAd);
            document.getElementById('share-ref-btn').addEventListener('click', handleShareReferral);
            document.getElementById('withdraw-form').addEventListener('submit', handleWithdrawSubmit);
            
            document.getElementById('amount-trx').addEventListener('input', () => {
                const trx = parseFloat(document.getElementById('amount-trx').value);
                const withdrawUsd = document.getElementById('withdraw-usd-amount');
                if (isNaN(trx) || trx <= 0 || currentTronPriceUsd === 0) {
                    withdrawUsd.textContent = '$0.00';
                } else {
                    withdrawUsd.textContent = `$${(trx * currentTronPriceUsd).toFixed(4)}`;
                }
            });
            // Arama kutusuna anlık filtreleme (Opsiyonel: Performans için buraya debounce eklenebilir)
            document.getElementById('user-search-input').addEventListener('input', () => {
                 loadAllUsers();
            });

            const navButtons = document.querySelectorAll('.bottom-nav .nav-btn');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const pageId = button.dataset.page;
                    window.showSection(pageId); 
                });
            });
        }

        const initApp = async () => {
            const tg = window.Telegram.WebApp;
            tg.ready();
            tg.expand();
            
            const user = tg.initDataUnsafe.user;
            if (!user || !user.id) {
                tg.showAlert("Could not verify user. Please open this app through Telegram.", () => tg.close());
                return;
            }
            
            telegramId = user.id.toString();
            userUid = getUidFromTelegramId(telegramId);
            
            const referralInput = document.getElementById('referral-code-input');
            if (referralInput) {
                referralInput.value = telegramId;
                referralInput.placeholder = telegramId;
            }

            if (ADMIN_TELEGRAM_IDS.includes(telegramId)) {
                document.getElementById('admin-indicator').style.display = 'block';
                const nav = document.querySelector('.bottom-nav');
                if (!document.querySelector('.nav-btn[data-page="admin-panel"]')) {
                    const adminBtn = document.createElement('button');
                    adminBtn.className = 'nav-btn';
                    adminBtn.dataset.page = 'admin-panel';
                    adminBtn.innerHTML = '<i class="fas fa-user-shield"></i><span>Admin</span>';
                    adminBtn.addEventListener('click', () => showSection('admin-panel')); 
                    nav.appendChild(adminBtn);
                }
            }
            
            const isBanned = await checkUserBan();
            if (isBanned) {
                return;
            }
            
            await fetchTronPrice();
            setupUserListener();
            setupEventListeners();
            setupSecurityMonitor();
            
            showSection('menu-page'); 
        };
        
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
